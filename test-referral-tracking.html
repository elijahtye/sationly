<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Referral Tracking</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    h2 { color: #666; margin-top: 0; }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #0056b3; }
    .result {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .success { border-left: 4px solid #28a745; }
    .info { border-left: 4px solid #17a2b8; }
    .warning { border-left: 4px solid #ffc107; }
    code {
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.9em;
    }
  </style>
  <script src="referral-tracker.js"></script>
</head>
<body>
  <h1>ðŸ§ª Referral Tracking Test Tool</h1>
  
  <div class="test-section">
    <h2>1. Test Referral Link Detection</h2>
    <p>Simulate visiting a referral link:</p>
    <button onclick="testReferralLink('elijahtye')">Test /elijahtye Link</button>
    <button onclick="testReferralLink('invalid')">Test Invalid Link</button>
    <div id="link-result" class="result" style="display:none;"></div>
  </div>

  <div class="test-section">
    <h2>2. Check Stored Referral Code</h2>
    <p>See what referral code is currently stored:</p>
    <button onclick="checkStoredCode()">Check Stored Code</button>
    <div id="stored-result" class="result" style="display:none;"></div>
  </div>

  <div class="test-section">
    <h2>3. Manual Referral Code Storage</h2>
    <p>Manually set a referral code:</p>
    <input type="text" id="manual-code" placeholder="Enter referral code" style="padding: 8px; width: 200px;">
    <button onclick="setManualCode()">Set Code</button>
    <div id="manual-result" class="result" style="display:none;"></div>
  </div>

  <div class="test-section">
    <h2>4. Clear Referral Code</h2>
    <p>Remove stored referral code:</p>
    <button onclick="clearCode()">Clear Code</button>
    <div id="clear-result" class="result" style="display:none;"></div>
  </div>

  <div class="test-section">
    <h2>5. Test Checkout Session Creation</h2>
    <p>Simulate what happens when creating a checkout session (requires auth):</p>
    <button onclick="testCheckoutPayload()">Show Checkout Payload</button>
    <div id="checkout-result" class="result" style="display:none;"></div>
  </div>

  <div class="test-section">
    <h2>6. View All localStorage Data</h2>
    <p>See all referral-related data in localStorage:</p>
    <button onclick="viewAllData()">View All Data</button>
    <div id="all-data-result" class="result" style="display:none;"></div>
  </div>

  <script>
    function showResult(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = `result ${type}`;
      element.style.display = 'block';
    }

    function testReferralLink(code) {
      // Simulate URL change
      const originalPath = window.location.pathname;
      window.history.pushState({}, '', `/${code}`);
      
      // Trigger referral check
      const detected = window.referralTracker?.checkUrlForReferral();
      
      // Restore original path
      window.history.pushState({}, '', originalPath);
      
      if (detected) {
        showResult('link-result', `âœ… Referral code detected: "${detected}"\n\nCode has been stored in localStorage.`, 'success');
      } else {
        showResult('link-result', `âŒ No valid referral code detected.\n\nCode "${code}" is not in the valid referral codes list.`, 'warning');
      }
      
      // Check what was actually stored
      setTimeout(() => {
        const stored = window.referralTracker?.getReferralCode();
        if (stored) {
          showResult('link-result', document.getElementById('link-result').textContent + `\n\nStored code: "${stored}"`, 'success');
        }
      }, 100);
    }

    function checkStoredCode() {
      const code = window.referralTracker?.getReferralCode();
      const timestamp = localStorage.getItem('sationly_referral_timestamp');
      
      if (code) {
        const date = timestamp ? new Date(parseInt(timestamp, 10)).toLocaleString() : 'Unknown';
        const age = timestamp ? Math.floor((Date.now() - parseInt(timestamp, 10)) / (1000 * 60 * 60 * 24)) : 0;
        const remainingDays = 30 - age;
        
        showResult('stored-result', 
          `âœ… Referral code found!\n\n` +
          `Code: "${code}"\n` +
          `Stored at: ${date}\n` +
          `Age: ${age} days\n` +
          `Expires in: ${remainingDays} days\n\n` +
          `This code will be included in checkout sessions.`,
          'success'
        );
      } else {
        showResult('stored-result', 
          `âŒ No referral code stored.\n\n` +
          `Visit a referral link (e.g., /elijahtye) to store one.`,
          'warning'
        );
      }
    }

    function setManualCode() {
      const code = document.getElementById('manual-code').value.trim();
      if (!code) {
        showResult('manual-result', 'âŒ Please enter a referral code.', 'warning');
        return;
      }
      
      const success = window.referralTracker?.setReferralCode(code);
      if (success) {
        showResult('manual-result', 
          `âœ… Referral code "${code}" stored successfully!\n\n` +
          `It will be included in checkout sessions.`,
          'success'
        );
      } else {
        showResult('manual-result', 
          `âŒ Invalid referral code: "${code}"\n\n` +
          `Valid codes: elijahtye\n` +
          `Add more codes in referral-tracker.js`,
          'warning'
        );
      }
    }

    function clearCode() {
      window.referralTracker?.clearReferralCode();
      showResult('clear-result', 
        `âœ… Referral code cleared!\n\n` +
        `localStorage has been cleaned.`,
        'success'
      );
    }

    function testCheckoutPayload() {
      const referralCode = window.referralTracker?.getReferralCode();
      
      const payload = {
        tier: 'tier2',
        userId: 'test-user-id',
        referralCode: referralCode || null
      };
      
      showResult('checkout-result', 
        `ðŸ“¦ Checkout Session Payload:\n\n` +
        JSON.stringify(payload, null, 2) + `\n\n` +
        (referralCode 
          ? `âœ… Referral code "${referralCode}" will be included in Stripe metadata.`
          : `âš ï¸ No referral code - checkout will proceed without referral tracking.`),
        referralCode ? 'success' : 'warning'
      );
    }

    function viewAllData() {
      const data = {
        'sationly_referral_code': localStorage.getItem('sationly_referral_code'),
        'sationly_referral_timestamp': localStorage.getItem('sationly_referral_timestamp'),
        'timestamp_date': localStorage.getItem('sationly_referral_timestamp') 
          ? new Date(parseInt(localStorage.getItem('sationly_referral_timestamp'), 10)).toLocaleString()
          : null
      };
      
      showResult('all-data-result', 
        `ðŸ“Š All Referral Data in localStorage:\n\n` +
        JSON.stringify(data, null, 2),
        'info'
      );
    }

    // Check on page load
    window.addEventListener('DOMContentLoaded', () => {
      const code = window.referralTracker?.getReferralCode();
      if (code) {
        console.log('[test] Referral code detected on page load:', code);
      }
    });
  </script>
</body>
</html>

